<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COVID-19 World Map_2</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    .tooltip {
      position: absolute;
      text-align: center;
      width: auto;
      height: auto;
      padding: 5px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
      opacity: 0;
    }
    .highlight {
      stroke: #000;
      stroke-width: 1px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const width = 960, height = 600;

    const svg = d3.select("#map").append("svg")
      .attr("width", width)
      .attr("height", height);

    const projection = d3.geoMercator()
      .scale(150)
      .translate([width / 2, height / 1.5]);

    const path = d3.geoPath()
      .projection(projection);

    const tooltip = d3.select("body").append("div")
      .attr("class", "tooltip");

    // Function to map country names if necessary
    const countryNameMapping = {
      "United States": "US",
      // Add other mappings if necessary
    };

    const getCountryName = name => countryNameMapping[name] || name;

    // Load data files
    Promise.all([
      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
      d3.csv("data/time_series_covid19_deaths_global_latest.csv"),
      d3.csv("data/time_series_covid19_confirmed_global_latest.csv")
    ]).then(function([world, deaths, confirmed]) {

      // Process deaths data
      const deathsData = {};
      deaths.forEach(d => {
        const country = getCountryName(d["Country/Region"]);
        const latestDeaths = +d[Object.keys(d).pop()];
        deathsData[country] = (deathsData[country] || 0) + latestDeaths;
      });

      // Process confirmed cases data
      const confirmedData = {};
      confirmed.forEach(d => {
        const country = getCountryName(d["Country/Region"]);
        const latestConfirmed = +d[Object.keys(d).pop()];
        confirmedData[country] = (confirmedData[country] || 0) + latestConfirmed;
      });

      // Merge data into a single object
      const data = {};
      for (const country in confirmedData) {
        data[country] = {
          confirmed: confirmedData[country],
          deaths: deathsData[country] || 0
        };
      }

      // Create a color scale
      const colorScale = d3.scaleSequential(d3.interpolateReds)
        .domain([0, d3.max(Object.values(data), d => d.confirmed)]);

      // Draw the map
      svg.append("g")
        .selectAll("path")
        .data(world.features)
        .enter().append("path")
        .attr("d", path)
        .attr("fill", d => {
          const country = getCountryName(d.properties ? d.properties.name : null);
          return data[country] ? colorScale(data[country].confirmed) : "#ccc";
        })
        .attr("class", "country")
        .on("mouseover", function(event, d) {
          const country = getCountryName(d.properties ? d.properties.name : null);
          if (country && data[country]) {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`${country}<br>Confirmed: ${data[country].confirmed}<br>Deaths: ${data[country].deaths}`)
              .style("left", (event.pageX + 5) + "px")
              .style("top", (event.pageY - 28) + "px");
          }
        })
        .on("mouseout", function(d) {
          tooltip.transition().duration(500).style("opacity", 0);
        })
        .on("click", function(event, d) {
          const country = getCountryName(d.properties ? d.properties.name : null);
          if (country && data[country]) {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`${country}<br>Confirmed: ${data[country].confirmed}<br>Deaths: ${data[country].deaths}`)
              .style("left", (event.pageX + 5) + "px")
              .style("top", (event.pageY - 28) + "px");

            // Highlight the clicked country
            svg.selectAll("path")
              .classed("highlight", d => getCountryName(d.properties ? d.properties.name : null) === country);
          }
        });

    }).catch(function(error) {
      console.error('Error loading or processing data:', error);
    });
  </script>
</body>
</html>
